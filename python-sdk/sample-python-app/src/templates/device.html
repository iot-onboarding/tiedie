<!--
Copyright (c) 2023, Cisco and/or its affiliates.
All rights reserved.
See LICENSE file in this distribution.
SPDX-License-Identifier: Apache-2.0
-->

<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:insert="~{layout :: head}">
    <title id="title">Device</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src=" https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.1.3/socket.io.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>

<body th:insert="~{layout :: body}">
    <div id="main">
        <h1>Device Information</h1>

        {% if parameters != None %}
            <span class="badge rounded-pill text-bg-success">Connected</span>
        {% endif %}

        <table class="table">
            <tbody>
                <tr>
                    <th>Device ID</th>
                    <td>{{ device.deviceID }}</td>
                </tr>
                <tr>
                    <th>Device Display Name</th>
                    <td>{{ device.deviceDisplayName }}</td>
                </tr>
                <tr>
                    <th>Device MAC Address</th>
                    <td>{{ device.ble_extension.device_mac_address }}</td>
                </tr>
                <tr>
                    <th>Device Pass Key</th>
                    <td>{{ device.ble_extension.pairing_pass_key.key }}</td>
                </tr>
                <tr>
                    <th>Device Version Support</th>
                    <td>{{ device.ble_extension.version_support }}</td>
                </tr>
            </tbody>
        </table>
    </div>

    {% if parameters != None %}
    <div class="row">
        <form class="col-4" action="/devices/{{ device.deviceID }}/connect" method="POST">
            <button type="submit" class="btn btn-primary">Connect</button>
        </form>
      
        <form class="col-4" action="/devices/{{ device.deviceID }}/delete" method="POST">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      
        <form class="col-4" action="/devices/{{ device.deviceID }}/advertisements" method="POST">
          <button type="submit" class="btn btn-success">Subscribe to advertisements</button>
        </form>
      
        <form class="col-4" action="/devices/{{ device.deviceID }}/disconnect" method="POST">
          <button type="submit" class="btn btn-danger">Disconnect</button>
        </form>
    </div>
    {% endif %}

    
    <div class="row" {% if parameters is none %}style="display:none"{% endif %}>
        <table class="table">
            <thead>
                <th scope="col">GATT Service UUID</th>
                <th scope="col">GATT Characteristic UUID</th>
                <th scope="col">Value</th>
                <th scope="col"></th>
            </thead>
            <tbody>
                {% for parameter in parameters %}
                <tr>
                    <td class="ble-ad-data text-black" scope="row">{{ parameter.serviceUUID }}</td>
                    <td class="ble-ad-data text-black">{{ parameter.charUUID }}</td>
                    <td class="ble-ad-data text-black" id="value-{{ loop.index0 }}"></td>
                    <td>
                        {% if 'read' in parameter.flags %}
                        <button class="btn btn-primary" onclick="readValue('{{ loop.index0 }}', '{{ device.deviceID }}', '{{ parameter.serviceUUID }}', '{{ parameter.charUUID }}')">Read</button>
                        {% endif %}
                        {% if 'write' in parameter.flags %}
                        <form onsubmit="writeValue('{{ loop.index0 }}', '{{ device.deviceID }}', '{{ parameter.serviceUUID }}', '{{ parameter.charUUID }}', this.querySelector('input').value); return false;">
                            <input type="text" class="form-control" placeholder="Enter value" id="writeValue-{{ loop.index0 }}">
                            <button type="submit" class="btn btn-primary">Write</button>
                        </form>                      
                        {% endif %}
                        {% if 'notify' in parameter.flags or 'indicate' in parameter.flags %}
                        <button class="btn btn-warning" onclick="subscribe('{{ loop.index0 }}', '{{ device.deviceID }}', '{{ parameter.serviceUUID }}', '{{ parameter.charUUID }}')">Subscribe</button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    {% raw %}

    <script type="text/javascript">

            function writeValue(index, deviceId, serviceUUID, charUUID, value) {
                // Prepare the data to be sent in the request
                var data = {
                value: value
                };

                // Send the AJAX request to the server
                $.ajax({
                url: '/devices/' + deviceId + '/svc/' + serviceUUID + '/char/' + charUUID + '/write',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
                success: function(response) {
                    // Handle the success response
                    console.log('Write operation successful:', response);
                    // Update the UI or perform any other necessary actions
                },
                error: function(xhr, status, error) {
                    // Handle the error response
                    console.error('Error occurred during write operation:', error);
                    // Update the UI or display an error message
                }
                });
            } 

            function readValue(index, id, svcUUID, charUUID) {
                // call API with svcUUID and charUUID
                console.log("readValue: " + svcUUID + ", " + charUUID + ", " + index + ", " + id);

                fetch(`/devices/${id}/svc/${svcUUID}/char/${charUUID}/read`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        document.getElementById(`value-${index}`).innerHTML = data.value;
                    });
            }


            function subscribe(index, id, svcUUID, charUUID, value) {
                // call API with svcUUID and charUUID
                console.log("subscribe: " + svcUUID + ", " + charUUID);

                fetch(`/devices/${id}/svc/${svcUUID}/char/${charUUID}/subscribe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                        var topic = data.topic;
                        window.location.href = `/subscription?topic=${topic}`;
                    });
            }

            var path = window.location.pathname;
            var id = path.split("/")[2];

            var topic = `data-app/${id}/connection`;

            var ws = io("ws://localhost:3000/connectionstatus");

            ws.on("connect", () => {
                    console.log("Connected to server");
                    ws.emit("subscribe", topic);
            });

            ws.on("data", event => {
                var obj = JSON.parse(event.data);

                console.log(obj);
            });
    </script>
    {% endraw %}
  </div>
</body>

</html>